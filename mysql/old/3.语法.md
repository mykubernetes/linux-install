# 基础管理下

补充：

```sh
	8.0之前, alter 语句在业务繁忙期间做,会有很严重的锁问题.
	5.6 5.7中变更时,做好是使用pt-osc 或者gh-ost
```

DDL规范：

```sh
1. 建库: 库名,和业务有关.不要大写字母,不能用系统关键字,不能数字开头.显式的设置字符集.
2. 建表: 
	a. 表名,和业务有关,要有表注释.
	例如:jifeidb ----> jf_t1
   	 b. 表名长度,16个字符以内.
	c. 显式的设置存储引擎和字符集
	d. 列名,要有业务相关度.
	e. 数据类型: 合适  简短  足够
	f. 每个表必须要创建主键,最好是业务无关列,最好是数字自增列.
	g. 尽量对每个列进行Not null,并设置默认值
	h. 每个列要有注释.
	i. 修改表结构(Online-DDL),要在业务不繁忙去做,8.0建议使用pt-osc  gh-ost.
```

UNION 和 UNION ALL 区别?

```
UNION 自动去重复行 ,会有更多性能消耗(去重复意味着要排序)
```

 面试题: 5.7+ 的 SQL_mode=only_full_group_by

```
ERROR 1055 (42000): 
Expression #3 of SELECT list is not in GROUP BY clause and contains nonaggregated column 'world.city.Name' which is not functionally dependent on columns in GROUP BY clause; this is incompatible with sql_mode=only_full_group_by

解: 

 	1. 如果select 后的查询列表,不是group by 的条件,又不在聚合函数中存在.就会和SQL_mode不兼容 .
     如果group by 后的列是主键或唯一键时,可以忽略.
     2. 原理: 
        group by 执行过程
        取数据 ---> 对group by 的列进行排序和去重,在对其他列进行聚合,如果出现没有聚合的条件列值,结果集就会出现
        1个值对多个值,出现不规则表结构.
```



## 表

1.建表

```sh
CREATE TABLE `wdnmd` (
  `kuku` char(10) NOT NULL DEFAULT 'go',
  `xulie` int NOT NULL AUTO_INCREMENT COMMENT '序列号',
  `xingmign` varchar(6) NOT NULL COMMENT '姓名',
  `nianling` varchar(20) NOT NULL,
  `state` int NOT NULL DEFAULT '1',
  `haha` varchar(20) NOT NULL DEFAULT 'xingma',
  PRIMARY KEY (`xulie`)
) ENGINE=InnoDB AUTO_INCREMENT=5 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
```

2.快速建表

```sh
mysql> create table wdnmd like student;   #建一个像student的表
```

3.删除表

```sh
mysql> drop table haha;
mysql> truncate table haha;
******区别******
	drop       连表结构+数据全部清空
    truncate   只清空数据,保留表结构
    delete from t1     : 逻辑删除(删除标记).不会降低高水位.不会立即释放磁盘空间.
```



## 列

1.插入列

```sh
mysql> alter table wdnmd add haha varchar(20) not null default 'xingma';
                    表名      列名
第一行插入：
mysql> alter table wdnmd add kuku varchar(20) not null first;
在某列后面插入：
mysql> alter table wdnmd add gggg varchar(20) not null after kuku;
```

2.删除列（危险）

```sh
mysql> alter table wdnmd drop gggg;     #删除gggg列
```

3.修改列的数据类型

```sh
mysql> alter table wdnmd modify kuku char(10) not null default 'go';  #修改kuku列属性
```

4.修改列名和属性

```sh
mysql> alter table wdnmd change age nianling varchar(20) not null; 
   #把 age 改成 nianling 以及修改其属性
```



## DCL语句

1.grant    授权



2.revoke  回收权    （上一章已写）



## DML语句

### 增：

```sh
mysql> desc student;
+----------+------------+------+-----+---------+----------------+
| Field    | Type       | Null | Key | Default | Extra          |
+----------+------------+------+-----+---------+----------------+
| xulie    | int        | NO   | PRI | NULL    | auto_increment |
| xingmign | varchar(6) | NO   |     | NULL    |                |
| age      | int        | NO   |     | 18      |                |
+----------+------------+------+-----+---------+----------------+

mysql> insert into student values(1,'zhuanghan','20');  #增加内容
快速增加：
mysql> insert into haha select * from student;   #前提：表结构相同
```

### 改：

```sh
mysql> select * from student;
+-------+----------+-----+
| xulie | xingmign | age |
+-------+----------+-----+
|     1 | zhuang   |  18 |
+-------+----------+-----+

mysql> update student set xingmign='han' where xulie=1;  #把序列为1的姓名改为han
```

### 删：

```sh
mysql> select * from student;
+-------+----------+-----+
| xulie | xingmign | age |
+-------+----------+-----+
|     1 | zhuang   |  18 |
|     2 | zhuang   |  20 |
+-------+----------+-----+

mysql> delete from student where xulie=2;
一般使用伪删除，用update 代替 delete
先增加一状态列：
mysql> alter table student add state char(1) not null default 1;
把需要删除的项状态标记0：
mysql> update student set state=0 where xulie=1;
```

### 查：

select

1.查询变量

```sh
mysql> select @@datadir;
mysql> select @@innodb_flush_log_at_trx_commit;
查询所有变量：
mysql> show variables;
查询不确定变量：
mysql> show variables like '%trx%';    # %相当于liunx里的通配符*
```

2.调用函数

```sh
mysql> select version();
mysql> select user();
mysql> select concat(user,"@",host)from mysql.user;    #改变输出方式
```

3.计算器

```sh
mysql> select 4*5;
```

4.select 基本语法

```sh
select  select_list
from       #从哪查
where      #条件是什么
group by   #以什么分组
having     #分组输出后要干什么
order by   #排序
limit      #输出哪几行
```

学习准备：

https://downloads.mysql.com/docs/world.sql.zip    下载官方练习数据库

mysql -uroot -p123 <./world.sql

```sh
mysql> desc city;
+-------------+----------+------+-----+---------+----------------+
| Field       | Type     | Null | Key | Default | Extra          |
+-------------+----------+------+-----+---------+----------------+
| ID          | int      | NO   | PRI | NULL    | auto_increment |
| Name        | char(35) | NO   |     |         |                |
| CountryCode | char(3)  | NO   | MUL |         |                |
| District    | char(20) | NO   |     |         |                |
| Population  | int      | NO   |     | 0       |                |
+-------------+----------+------+-----+---------+----------------+
```

4.1  where （and or in between and）

```sh
1.查询中国的城市
mysql> select * from city where countrycode='CHN';
2.查询中国的城市且人口小于100000的
mysql> select * from city where countrycode='CHN' and population<100000;
3.查询中国的城市或美国的城市
mysql> select * from city where countrycode='CHN' or countrycode='USA';
mysql> select * from city where countrycode in ('CHN','USA');
4.查询人口在10000到200000之间的中国城市
mysql> select * from city where countrycode='CHN' and population between 1000000 and 2000000;
```

4.2 group by  +  聚合函数（sum count...）

--- GROUP BY + 聚合函数的执行逻辑
取数据--->排序--->去重----> 聚合

```sh
1.统计每个国家的城市个数
mysql> select countrycode,count(id) from city group by countrycode;
#以国家代号分组，查询城市个数

2.查询每个国家的总人口数
mysql> select countrycode,sum(population) from city group by countrycode;

3.查看中国每个省的城市数
mysql> select district,count(id) from city where countrycode='CHN' group by district;

4.查看中国每个省的总人口数
mysql> select district,sum(population) from city where countrycode='CHN' group by district;

5.查看中国每个省有多少城市，并打印出名字  **************
mysql> SELECT district,COUNT(id),GROUP_CONCAT(NAME) FROM city  WHERE countrycode='CHN' GROUP BY district;
# 直接查询name 不行，要加 group_concat(name) 才可以
```

4.3  having

在group by 执行完之后又一限制条件可以使用having

```sh
1.查看中国每个省的总人口数,并打印出人口大于500000的城市
mysql> select district,sum(population) from city where countrycode='CHN' group by district having sum(population)>5000000;

```

4.4  order by  

```sh
1.查询中国各个省的总人口，打印出大于500000人口，并排序
mysql> select district,sum(population) from city where countrycode='CHN' group by district having sum(population)>5000000 order by sum(population);
2.  倒着排序
...order by sum(population) desc;
```

4.5 limit 

一般显示出第几到第几

```sh
统计每个国家的总人口,过滤输出总人口超过5000w的信息,只显示前三名：
mysql> select countrycode,sum(population) from city group by countrycode having sum(population)>10000000 order by sum(population) desc limit 3;
统计每个国家的总人口,过滤输出总人口超过5000w的信息,只显示4到6名：
mysql> select countrycode,sum(population) from city group by countrycode having sum(population)>10000000 order by sum(population) desc limit 3,2;
```

4.6 别名

```sh
SELECT a.countrycode AS ct,SUM(a.population) AS sum_p
FROM city AS a
GROUP BY a.countrycode
HAVING sum_p>50000000
ORDER BY sum_p DESC 
LIMIT 3 OFFSET 3 ;
```

