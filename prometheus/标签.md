# 概述

Prometheus 发现、抓取和处理不同类型的 label 标签对象，根据标签值操作或过滤这些对象非常有用，比如：
- 只监视具有特定服务发现注解的某些目标，通常在服务发现中使用
- 向目标抓取请求添加 HTTP 查询参数
- 仅存储从指定目标中提取样本的子集
- 将抓取序列的两个标签值合并为一个标签

Relabeling 是作为一系列转换步骤实现的，我们可以在 Prometheus 的配置文件中应用这些步骤来过滤或修改标记对象，我们可以对一下类型的标记对象应用 Relabeling 操作：
- 发现的抓取目标（`relabel_configs`）
- 抓取的单个样本（`metric_relabel_configs`）
- 发送给 Alertmanager 的报警（`alert_relabel_configs`）
- 写到远程存储的样本（`write_relabel_configs`）

# 隐藏的标签与元数据

以双下划线__开头的标签属于特殊的标签，它们在重新标记后会被删除。标记对象的来源最初可以附加这些**隐藏**的标签，以提供关于标记对象的额外元数据，这些特殊的标签可以在 relabeling 阶段被用来对对象的标签进行修改。

对于抓取指标，其中就包含一些隐藏的标签，可以用来控制目标应该如何被抓取。
- `__address__`：包含应该被抓取目标的地址，它最初默认为服务发现机制提供的 `<host>:<port>`，如果在此之前没有明确地将实例标签 instance 设置为其他值，那么在 relabeling 之后，Prometheus 会将 instance 标签设置为 __address__ 的值。
- `__scheme__`：抓取目标的请求模式，包括 http 与 https，默认为 http。
- `__metrics_path__`：表示用于采集指标的 HTTP 路径，默认为 `/metrics`。
- `__param_<name>`: 包含 HTTP 查询参数名称和它们的值。

上面的这些标签都可以使用 relabeling 规则来设置或覆盖，这样就可以为抓取目标进行自定义抓取行为。 
 
此外，服务发现机制也可以提供一组以`__meta_`开头的标签，包含关于目标的特定发现元数据。例如，当发现 Kubernetes 集群中的 pod 时，Kubernetes服务发现引擎将为每个 pod 目标提供一个`__meta_kubernetes_pod_name` 的标签，包含被发现的 pod 的名字，以及一个`__meta_kubernetes_pod_ready` 标签，表明 pod 是否处于就绪状态，关于服务发现生成的元标签可以查看官方文档 https://prometheus.io/docs/prometheus/latest/configuration/configuration/#kubernetes_sd_config 了解更多。

 如果一个 relabeling 步骤需要将一个值保存到一个临时标签中（以便在随后的步骤中处理），那么我们可以使用 __tmp 标签名称前缀进行标记，以 __tmp 开通的标签是不会被 Prometheus 本身使用的。
 
 
# Relabeling 规则

Relabeling 规则主要由以下的一些配置属性组成，但对于每种类型的操作，只使用这些字段的一个子集。
- `action`：执行的 relabeling 动作，可选值包括 `replace`、`keep`、`drop`、`hashmod`、`labelmap`、`labeldrop`或者`labelkeep`，默认值为`replace`。
- `separator`：分隔符，一个字符串，用于在连接源标签 source_labels 时分隔它们，默认为`;`。
- `source_labels`：源标签，使用配置的分隔符串联的标签名称列表，并与提供的正则表达式进行匹配。
- `target_label`：目标标签，当使用 replace 或者 hashmod 动作时，应该被覆盖的标签名。
- `regex`：正则表达式，用于匹配串联的源标签，默认为 `(.*)`，匹配任何源标签。
- `modulus`：模数，串联的源标签哈希值的模，主要用于 Prometheus 水平分片。
- `replacement`：replacement 字符串，写在目标标签上，用于替换 relabeling 动作，它可以参考由 regex 捕获的正则表达式捕获组,默认为`$1`。
 
Relabel的action
---
| ACTION | Regex匹配 | 操作对象 | 重要参数 | 描述 |
|--------|-----------|--------|--------|------|
| keep | 标签值 | Target | 源标签、regex | 丢弃指定源标签的标签值没有匹配到regex的target |
| Drop | 标签值 | Target | 源标签、regex | 丢弃指定源标签的标签值匹配到regex的target |
| labeldrop | 标签名 | Label | Regex | 丢弃匹配到regex 的标签 |
| labelkeep | 标签名 | Label | Regex | 丢弃没有匹配到regex 的标签 |
| Replace | 标签值 | Label名+值 | 源标签、目标标签、替换（值）、regex（值） | 更改标签名、更改标签值、合并标签 |
| hashmod | 无 | 标签名+值 | 源标签、hash长度、target标签  | 将多个源标签的值进行hash，作为target标签的值 |
| labelmap | 标签名 | 标签名 | regex、replacement | Regex匹配名->replacement用原标签名的部分来替换名 |

过滤target
---
1、使用keep，保留标签值匹配regex的targets
```
scrape_configs:
 - …
 - job_name: "cephs"
    relabel_configs:
      - action: keep
        source_labels:
          -  __address__
        regex:  ceph01.* 
```
relabel结果可以在Prometheus网页的status/ Service Discovery中查看



2、使用drop，丢弃匹配regex的targets
```
scrape_configs:
 - …
 - job_name: "cephs"
    relabel_configs:
      - action: drop
        source_labels:
          -  __address__
        regex:  ceph01.*
```

删除标签
---
1、将标签名为job的标签删除
```
scrape_configs:
 - …
  - job_name: "cephs"
    relabel_configs:
      - regex: job
        action: labeldrop
```
labelKeep和labeldrop不操作’__’开头的标签，要操作需要先改名

修改label名
---

1、使用replace将scheme标签改名为protocol
```
scrape_configs:
  - …
  - job_name: "cephs"
    relabel_configs:
      - source_labels:
          - __scheme__
        target_label: procotol
```

这里可以是多个source_labels，只有值匹配到regex，才会进行替换

2、使用labelmap，将原始标签的一部分转换为target标签，这一功能replace无法实现
```
scrape_configs:
  - …
  - job_name: "sd_file_mysql"
    file_sd_configs:
      - files:
        - mysql.yml
        refresh_interval: 1m
    relabel_configs:
      - action: labelmap
        regex: (.*)(address)(.*) 
        replacement: ${2}
```

修改label值
---
配置k8s服务发现
```
scrape_configs:
  - …
  - job_name: "sd_k8s_nodes"
    kubernetes_sd_configs:
      - role: node
        bearer_token_file: bearer_token
        tls_config:
          ca_file: ca.crt
        namespaces:
          names:
            - default
        api_server: https://master01:6443
```

服务发现完成后，默认node的port是10250，会无法取得数据，同通过relabel修改标签.
```
relabel_configs:
      - source_labels:
         - __address__
        regex: (.*)\:10250
        replacement: "${1}:10255"
        target_label: __address__
```

多标签合并
---
标签合并，可以将多个源标签合并为一个目标标签，可以取源标签的值，也可以进行hash，用户target分组

1、在文件服务发现中，将标签filename="mysql.yml" 和sd_type="file"合并为sd=”file;mysql.yml”，标签值使用分号连接
```
scrape_configs:
- …
  - job_name: "sd_file_mysql"
    file_sd_configs:
      - files:
        - mysql.yml
        refresh_interval: 1m
    relabel_configs:
      - source_labels:
          - sd_type
          - filename
        separator: ;
        target_label: sd
```

2、将多个标签的值进行hash，形成一个target标签，只要target标签一致，则表示源标签一致，可以用来实现prometheus的负载均衡
```
scrape_configs:
  - …
  - job_name: "sd_file_mysql"
    file_sd_configs:
      - files:
        - mysql.yml
        refresh_interval: 1m
    relabel_configs:
      - action: hashmod
        source_labels:
          - __scheme__
          - __metrics_path__
        modulus: 64
        target_label: hash_id
```
