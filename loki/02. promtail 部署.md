Supervisor 是Python编写的 Client/Server 模式的系统，通过supervisor，可以对类Unix操作系统的进程进行监控和管理。可以方便地进行进程集中管理，并监控进程的状态。当程序异常退出时，可以自动拉起程序，起到守护进程的作用。

promtail 部署
```
mkdir /data/promtail/{bin,config,logs} -p
cd /data/promtail/bin
curl -O -L "https://github.com/grafana/loki/releases/download/v2.3.0/promtail-linux-amd64.zip"
unzip "promtail-linux-amd64.zip"
chmod a+x "promtail-linux-amd64"
```

## 启动 promtail

```
mkdir /data/promtail/{bin,config,logs} -p
cd /data/promtail/bin
curl -O -L "https://github.com/grafana/loki/releases/download/v2.3.0/promtail-linux-amd64.zip"
unzip "promtail-linux-amd64.zip"
chmod a+x "promtail-linux-amd64"

cat << EOF > /data/promtail/config/promtail.conf
server:
  http_listen_address: 0.0.0.0
  http_listen_port: 19080
  grpc_listen_port: 0

positions:
  filename: ./logs/loki_positions.yaml
  ignore_invalid_yaml: true

clients:
  - url: http://127.0.0.1:3100/loki/api/v1/push

scrape_configs:
- job_name: service_log
  file_sd_configs:
    - files:
      - ./config/*.yaml
      refresh_interval: 1m
EOF

cat << EOF > /etc/supervisord.d/promtail.ini
[program:promtail]
command=/data/promtail/bin/promtail-linux-amd64 -config.expand-env=true -config.file=/data/promtail/config/promtail.conf
autorestart=true
autostart=true
stderr_logfile=/tmp/promtail_err.log
stdout_logfile=/tmp/promtail_out.log
user=root
stopsignal=INT
startsecs=10
startretries=3
directory=/data/promtail/
EOF



cat << EOF > /data/promtail/config/varlogmessage.yaml
- targets:
    - localhost
  labels:
    __path__: /var/log/messages
    env: {{ENV}}
    hostname: {{BINDIP}}
    service_name: var-log-messages
    log_type: var-log-messages
- targets:
    - localhost
  labels:
    __path__: /var/log/secure
    env: {{ENV}}
    hostname: {{BINDIP}}
    service_name: var-log-secure
    log_type: var-log-secure
EOF

ENV=test
BINDIP=192.168.171.129
sed -i "s/{{ENV}}/$ENV/g" /data/promtail/config/varlogmessage.yaml
sed -i "s/{{BINDIP}}/$BINDIP/g" /data/promtail/config/varlogmessage.yaml
```

启动 promtail

查看loki 日志存储

通过api 查询loki中日志
```
# curl 127.0.0.1:3100/loki/api/v1/labels
{"status":"success","data":["__name__","env","filename","hostname","log_type","service_name"]}

# curl 127.0.0.1:3100/loki/api/v1/label/service_name/values
{"status":"success","data":["var-log-messages","var-log-secure"]}

curl 127.0.0.1:3100/loki/api/v1/label/filename/values
{"status":"success","data":["/var/log/messages","/var/log/secure"]}
``` 作者：阿果阿郭 https://www.bilibili.com/read/cv17329098 出处：bilibili
