# 一、文件存在判断

| 用法 | 描述 |
|-----|------|
| is exists | 存在则返回真 |
| is not exists | 不存在则返回真 |

## 1、判断一个文件存在
```
---
- hosts: web
  remote_user: root
  gather_facts: no
  vars:
    testpath: /testdir
  tasks:
  - debug:
      msg: "file exist"
    when: testpath is exists
```

```
# ansible-playbook test.yml 

PLAY [all] *********************************************************************************************************************************************

TASK [debug] *******************************************************************************************************************************************
ok: [192.168.101.69] => {
    "msg": "file exist"
}

PLAY RECAP *********************************************************************************************************************************************
192.168.101.69             : ok=1    changed=0    unreachable=0    failed=0   

```

## 2、判断一个文件不存在
```
---
- hosts: web
  remote_user: root
  gather_facts: no
  vars:
    testpath: /testdir1
  tasks:
  - debug:
      msg: "file not exist"
    when: testpath is not exists
```

```
# ansible-playbook test.yml 

PLAY [all] *********************************************************************************************************************************************

TASK [debug] *******************************************************************************************************************************************
skipping: [192.168.101.69]

PLAY RECAP *********************************************************************************************************************************************
192.168.101.69             : ok=0    changed=0    unreachable=0    failed=0 
```

## 3、使用not取反效果与”is not”的效果相同
```
---
- hosts: web
  remote_user: root
  gather_facts: no
  vars:
    testpath: /testdir1
  tasks:
  - debug:
      msg: "file not exist"
    when: not testpath is exists
```


# 二、变量是否定义判断

| 用法 | 描述 |
|-----|------|
| defined | 判断变量是否已经定义，已经定义则返回真 |
| undefind | 判断变量是否已经定义，未定义则返回真 |
| none | 判断变量值是否为空，如果变量已经定义，但是变量值为空，则返回真 |

## 1、变量是否存在测试
```
---
- hosts: web
  remote_user: root
  gather_facts: no
  vars:
    testvar: "test"
    testvar1:
  tasks:
  - debug:
      msg: "Variable is defined"
    when: testvar is defined
  - debug:
      msg: "Variable is undefined"
    when: testvar2 is undefined
  - debug:
      msg: "The variable is defined, but there is no value"
    when: testvar1 is none
```

```
# ansible-playbook test.yml
PLAY [all] *********************************************************************************************************************************************

TASK [debug] *******************************************************************************************************************************************
ok: [192.168.101.69] => {
    "msg": "Variable is defined"
}

TASK [debug] *******************************************************************************************************************************************
ok: [192.168.101.69] => {
    "msg": "Variable is undefined"
}

TASK [debug] *******************************************************************************************************************************************
ok: [192.168.101.69] => {
    "msg": "The variable is defined, but there is no value"
}

PLAY RECAP *********************************************************************************************************************************************
192.168.101.69             : ok=3    changed=0    unreachable=0    failed=0   
```

# 三、任务执行结果判断

| 用法 | 描述 |
|------|-----|
| success 或 succeeded | 通过任务的返回值信息判断任务的执行状态，任务执行成功则返回真 |
| failure 或 failed | 通过任务的返回值信息判断任务的执行状态，任务执行失败则返回真 |
| change 或 changed | 通过任务的返回值信息判断任务的执行状态，任务执行chage则返回真 |
| skip 或 skipped | 通过任务的返回值信息判断任务的执行状态，当任务没满足条件，而跳过执行时，则返回真 |

## 1、测试任务执行结果
```
---
- hosts: web
  remote_user: root
  gather_facts: no
  vars:
    doshell: "yes"
  tasks:
  - shell: "cat /testdir/abc"
    when: doshell == "yes"
    register: returnmsg
    ignore_errors: true
  - debug:
      msg: "success"
    when: returnmsg is success
  - debug:
      msg: "failed"
    when: returnmsg is failure
  - debug:
      msg: "changed"
    when: returnmsg is change
  - debug:
      msg: "skip"
    when: returnmsg is skip
```

```
# ansible-playbook test.yml 

PLAY [all] ******************************************************************************************************************************************************************************************************

TASK [shell] ****************************************************************************************************************************************************************************************************
fatal: [192.168.101.69]: FAILED! => {"changed": true, "cmd": "cat /testdir/abc", "delta": "0:00:00.002847", "end": "2021-09-07 10:32:51.186705", "msg": "non-zero return code", "rc": 1, "start": "2021-09-07 10:32:51.183858", "stderr": "cat: /testdir/abc: No such file or directory", "stderr_lines": ["cat: /testdir/abc: No such file or directory"], "stdout": "", "stdout_lines": []}
...ignoring

TASK [debug] ****************************************************************************************************************************************************************************************************
skipping: [192.168.101.69]

TASK [debug] ****************************************************************************************************************************************************************************************************
ok: [192.168.101.69] => {
    "msg": "failed"
}

TASK [debug] ****************************************************************************************************************************************************************************************************
ok: [192.168.101.69] => {
    "msg": "changed"
}

TASK [debug] ****************************************************************************************************************************************************************************************************
skipping: [192.168.101.69]

PLAY RECAP ******************************************************************************************************************************************************************************************************
192.168.101.69             : ok=3    changed=1    unreachable=0    failed=0
```

# 四、路径的判断

| 用法 | 描述 |
|------|------|
| file | 判断路径是否是一个文件，如果路径是一个文件则返回真 |
| directory | 判断路径是否是一个目录，如果是一个目录则返回真 |
| link | 判断路径是否是一个软连接，如果是一个软连接则返回真 |
| mount | 判断路径是否是一个挂载点，如果是一个挂载点则返回真 |
| exists | 判断路径是否存在，如果存在则返回真 |

- 上述判断为2.6版本中的名称，如果是2.5之前的版本需要加上is_前缀

```
---
- hosts: web
  remote_user: root
  gather_facts: no
  vars:
    testpath1: "/testdir/test"
    testpath2: "/testdir/"
    testpath3: "/testdir/testsoftlink"
    testpath4: "/testdir/testhardlink"
    testpath5: "/boot"
  tasks:
  - debug:
      msg: "file"
    when: testpath1 is file
  - debug:
      msg: "directory"
    when: testpath2 is directory
  - debug:
      msg: "link"
    when: testpath3 is link
  - debug:
      msg: "link"
    when: testpath4 is link
  - debug:
      msg: "mount"
    when: testpath5 is mount
  - debug:
      msg: "exists"
    when: testpath1 is exists
```

```
# ansible-playbook test.yml 

PLAY [all] ******************************************************************************************************************************************************************************************************

TASK [debug] ****************************************************************************************************************************************************************************************************
skipping: [192.168.101.69]

TASK [debug] ****************************************************************************************************************************************************************************************************
ok: [192.168.101.69] => {
    "msg": "directory"
}

TASK [debug] ****************************************************************************************************************************************************************************************************
skipping: [192.168.101.69]

TASK [debug] ****************************************************************************************************************************************************************************************************
skipping: [192.168.101.69]

TASK [debug] ****************************************************************************************************************************************************************************************************
ok: [192.168.101.69] => {
    "msg": "mount"
}

TASK [debug] ****************************************************************************************************************************************************************************************************
skipping: [192.168.101.69]

PLAY RECAP ******************************************************************************************************************************************************************************************************
192.168.101.69             : ok=2    changed=0    unreachable=0    failed=0
```

# 五、字符串判断

| 用法 | 描述 |
|-----|------|
| lower | 判断包含字母的字符串中的字母是否为纯小写，字符串中的字母全部为小写则返回为真 | 
| upper | 判断包含字母的字符串中的字母是否为纯大写，字符串中的字母全部为大写则返回为真 |

## 1、字符串测试
```
---
- hosts: web
  remote_user: root
  gather_facts: no
  vars:
    str1: "abc"
    str2: "ABC"
  tasks:
  - debug:
      msg: "This string is all lowercase"
    when: str1 is lower
  - debug:
      msg: "This string is all uppercase"
    when: str2 is upper
```

```
# ansible-playbook test.yml 

PLAY [all] ******************************************************************************************************************************************************************************************************

TASK [debug] ****************************************************************************************************************************************************************************************************
ok: [192.168.101.69] => {
    "msg": "This string is all lowercase"
}

TASK [debug] ****************************************************************************************************************************************************************************************************
ok: [192.168.101.69] => {
    "msg": "This string is all uppercase"
}

PLAY RECAP ******************************************************************************************************************************************************************************************************
192.168.101.69             : ok=2    changed=0    unreachable=0    failed=0
```

# 六、整除的判断

| 用法 | 描述 |
|------|-----|
| even | 判断数值是否是偶数，是偶数则返回真 |
| odd | 判断数值是否是奇数，是奇数则返回真 |
| divisibleby(num) | 判断是否可以正吃指定的数值，如果除以指定的数值以后余数为0，则返回真 |

## 1、整除判断测试
```
---
- hosts: web
  remote_user: root
  gather_facts: no
  vars:
    num1: 4
    num2: 7
    num3: 64
  tasks:
  - debug:
      msg: "An even number"
    when: num1 is even
  - debug:
      msg: "An odd number"
    when: num2 is odd
  - debug:
      msg: "Can be divided exactly by"
    when: num3 is divisibleby(8)
```

```
# ansible-playbook test.yml 

PLAY [all] ******************************************************************************************************************************************************************************************************

TASK [debug] ****************************************************************************************************************************************************************************************************
ok: [192.168.101.69] => {
    "msg": "An even number"
}

TASK [debug] ****************************************************************************************************************************************************************************************************
ok: [192.168.101.69] => {
    "msg": "An odd number"
}

TASK [debug] ****************************************************************************************************************************************************************************************************
ok: [192.168.101.69] => {
    "msg": "Can be divided exactly by"
}

PLAY RECAP ******************************************************************************************************************************************************************************************************
192.168.101.69             : ok=3    changed=0    unreachable=0    failed=0 
```

# 七、版本判断

| 用法 | 描述 |
|-----|------|
| version | 可以用于对比两个版本号的大小，或者指定的版本号进行对比使用语法为version('版本号'，'比较操作符') |

- 注：2.5版本中version_compare更名为version

当版本比较时支持多种比较操作符
- 大于： >,gt
- 大于等于： >=,ge
- 小于： <,lt
- 小于等于： <=,le
- 等于： ==,=,eq
- 不等于： !=,<>,ne

```
---
- hosts: web
  remote_user: root
  vars:
    ver: 7.4.1708
    ver1: 7.4.1707
  tasks:
  - debug:
      msg: "This message can be displayed when the ver is greater than ver1"
    when: ver is version(ver1,">")
  - debug:
      msg: "system version {{ansible_distribution_version}} greater than 7.3"
    when: ansible_distribution_version is version("7.3","gt")
```

```
# ansible-playbook test.yml 

PLAY [all] ******************************************************************************************************************************************************************************************************

TASK [debug] ****************************************************************************************************************************************************************************************************
ok: [192.168.101.69] => {
    "msg": "This message can be displayed when the ver is greater than ver1"
}

TASK [debug] ****************************************************************************************************************************************************************************************************
ok: [192.168.101.69] => {
    "msg": "system version 7.4.1708 greater than 7.3"
}

PLAY RECAP ******************************************************************************************************************************************************************************************************
192.168.101.69             : ok=2    changed=0    unreachable=0    failed=0   
```
- 第一个task中，当ver的版本号大于ver1时，返回真，条件成立，debug模块输出”This message can be displayed when the ver is greater than ver1″
- 第二个task中，当facts中的ansible_distribution_version的值大于7.3时，返回真，条件成立，debug模块输出对应信息


# 八、子集父集判断

| 用法 | 描述 |
|-----|-------|
| subset | 判断一个list是不是另一个list的子集，是另一个list的子集则返回真 |
| superset | 判断一个list是不是另一个list的父集，是另一个list的父集则返回真 |

- 注：2.5版本中上述两个tests从issubset和issuperset更名为subset和superset

```
---
- hosts: web
  remote_user: root
  gather_facts: no
  vars:
    a:
    - 2
    - 5
    b: [1,2,3,4,5]
  tasks:
  - debug:
      msg: "A is a subset of B"
    when: a is subset(b)
  - debug:
      msg: "B is the parent set of A"
    when: b is superset(a)
```

```
# ansible-playbook test.yml 

PLAY [all] ******************************************************************************************************************************************************************************************************

TASK [debug] ****************************************************************************************************************************************************************************************************
ok: [192.168.101.69] => {
    "msg": "A is a subset of B"
}

TASK [debug] ****************************************************************************************************************************************************************************************************
ok: [192.168.101.69] => {
    "msg": "B is the parent set of A"
}

PLAY RECAP ******************************************************************************************************************************************************************************************************
192.168.101.69             : ok=2    changed=0    unreachable=0    failed=0
```

# 九、字符串和数值判断

| 用法 | 描述 |
|------|------|
| string | 判断对象是否是一个字符串，是字符串则返回真 |
| number | 判断对象是否是一个数字，是数字则返回真 |

## 1、字符串判断
```
---
- hosts: web
  remote_user: root
  gather_facts: no
  vars:
    testvar1: 1
    testvar2: "1"
    testvar3: a
  tasks:
  - debug:
      msg: "This variable is a string"
    when: testvar1 is string
  - debug:
      msg: "This variable is a string"
    when: testvar2 is string
  - debug:
      msg: "This variable is a string"
    when: testvar3 is string
```

## 2、数字判断
```
---
- hosts: web
  remote_user: root
  gather_facts: no
  vars:
    testvar1: 1
    testvar2: "1"
    testvar3: 00.20
  tasks:
  - debug:
      msg: "This variable is number"
    when: testvar1 is number
  - debug:
      msg: "This variable is a number"
    when: testvar2 is number
  - debug:
      msg: "This variable is a number"
    when: testvar3 is number
```
