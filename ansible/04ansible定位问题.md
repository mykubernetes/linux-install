# 一、debug模块

- debug模块是Ansible Playbook中最常用的调试模块，可以在Playbook执行过程打印调试信息，特别是跟when条件语句一起使用时，可以调试特定条件下的执行过程。比如：当变量a定义时，将a的值打印出来，当任务成功后，打印执行结果等等

## 1、debug参数说明
| 参数 | 参数说明 |
|-----|------|
| msg | 指定要打印的信息，如果没有指定，打印默认值`hello world`。 |
| var | 指定要打印的变量名，与msg参数互斥，二者只能有一个。注意：var参数中的变量不需要使用{{}}表达式，而msg中需要。 |
| verbosity | 控制哪种调试级别下输出，值为Integer。如果设为3，则只有在-vvv或更高调试级别下才会输出。 |

## 2、debug调试示例
```
---
- hosts: devops
  tasks:
  - name: show debug msg
    debug:
      msg: System {{inventory_hostname}} has uuid {{ansible_product_uuid}}
  - name: print gateway when it is defined
    debug:
      msg: System {{inventory_hostname}} has gateway {{ansible_default_ipv4.gateway}}
    when: ansible_default_ipv4.gateway is defined
  - name: show uptime
    shell: /usr/bin/uptime
    register: result
  - name: show uptime result
    debug:
      var: result
      verbosity: 2
  - name: display all vars of a host
    debug:
      var: hostvars[inventory_hostname]
      verbosity: 3
  - name: print two lines of messages
    debug:
      msg:
        - "first line msg"
        - "second line msg"
```

## 3、debug执行过程
```
# ansible-playbook debug.yml -v
Using /etc/ansible/ansible.cfg as config file

PLAY [node01] ******************************************************************************************************************************************

TASK [Gathering Facts] *********************************************************************************************************************************
Thursday 23 September 2021  09:21:45 -0400 (0:00:00.061)       0:00:00.061 **** 
ok: [192.168.101.69]

TASK [show debug msg] **********************************************************************************************************************************
Thursday 23 September 2021  09:21:46 -0400 (0:00:00.883)       0:00:00.944 **** 
ok: [192.168.101.69] => {
    "msg": "System 192.168.101.69 has uuid 1CA64D56-F48A-A64E-B82D-B31749084A76"
}

TASK [print gateway when it is defined] ****************************************************************************************************************
Thursday 23 September 2021  09:21:46 -0400 (0:00:00.071)       0:00:01.015 **** 
ok: [192.168.101.69] => {
    "msg": "System 192.168.101.69 has gateway 192.168.101.1"
}

TASK [show uptime] *************************************************************************************************************************************
Thursday 23 September 2021  09:21:46 -0400 (0:00:00.078)       0:00:01.094 **** 
changed: [192.168.101.69] => {"changed": true, "cmd": "/usr/bin/uptime", "delta": "0:00:00.004278", "end": "2021-09-23 09:21:46.788891", "rc": 0, "start": "2021-09-23 09:21:46.784613", "stderr": "", "stderr_lines": [], "stdout": " 09:21:46 up 1 day, 17:05,  3 users,  load average: 0.21, 0.13, 0.07", "stdout_lines": [" 09:21:46 up 1 day, 17:05,  3 users,  load average: 0.21, 0.13, 0.07"]}

TASK [show uptime result] ******************************************************************************************************************************
Thursday 23 September 2021  09:21:46 -0400 (0:00:00.386)       0:00:01.481 **** 
skipping: [192.168.101.69] => {"skipped_reason": "Verbosity threshold not met."}

TASK [display all vars of a host] **********************************************************************************************************************
Thursday 23 September 2021  09:21:46 -0400 (0:00:00.066)       0:00:01.548 **** 
skipping: [192.168.101.69] => {"skipped_reason": "Verbosity threshold not met."}

TASK [print two lines of messages] *********************************************************************************************************************
Thursday 23 September 2021  09:21:46 -0400 (0:00:00.064)       0:00:01.613 **** 
ok: [192.168.101.69] => {
    "msg": [
        "first line msg", 
        "second line msg"
    ]
}

PLAY RECAP *********************************************************************************************************************************************
192.168.101.69             : ok=5    changed=1    unreachable=0    failed=0   

Thursday 23 September 2021  09:21:47 -0400 (0:00:00.044)       0:00:01.657 **** 
=============================================================================== 
Gathering Facts --------------------------------------------------------------------------------------------------------------------------------- 0.88s
show uptime ------------------------------------------------------------------------------------------------------------------------------------- 0.39s
print gateway when it is defined ---------------------------------------------------------------------------------------------------------------- 0.08s
show debug msg ---------------------------------------------------------------------------------------------------------------------------------- 0.07s
show uptime result ------------------------------------------------------------------------------------------------------------------------------ 0.07s
display all vars of a host ---------------------------------------------------------------------------------------------------------------------- 0.06s
print two lines of messages --------------------------------------------------------------------------------------------------------------------- 0.04s
```

# 二、assert模块

- assert模块是用来断言playbook中给定的表达式。当表达式成功或失败时输出一些信息，帮助进行调试。assert模块可用作单元测试，每次修改playbook后，都通过assert断言判断有没有改变执行结果。

## 1、assert参数说明
| 参数 | 参数说明 |
|-----|------|
| fail_msg | 当断言失败时输出的消息。 |
| success_msg | 当断言成功时输出的消息。 |
| quite | 当为yes时，如果成功就不输出任何消息，为no时，断言成功会输出消息。 |
| that | 需要判断的表达式列表。 |

## 2、assert调试示例
```
---
- hosts: devops
  vars:
    command_result: 'the result is success'
    number_of_the_count: 5
    param: 90
  tasks:
  - name: assert param scope
    assert:
      that:
        - param <= 100
        - param >= 0
      fail_msg: "'param' must be between 0 and 100"
      success_msg: "'param' is between 0 and 100"
  - name: use quiet to avoid verbose output
    assert:
      that:
        - param <= 100
        - param >= 0
      quiet: yes
  - name: print origin fail msg
    assert:
      that:
        - "'success' in command_result"
        - number_of_the_count == 4
```

## 3、assert执行过程
```
# ansible-playbook assert.yml

PLAY [node01] ******************************************************************************************************************************************

TASK [Gathering Facts] *********************************************************************************************************************************
Thursday 23 September 2021  09:32:01 -0400 (0:00:00.060)       0:00:00.060 **** 
ok: [192.168.101.69]

TASK [assert param scope] ******************************************************************************************************************************
Thursday 23 September 2021  09:32:02 -0400 (0:00:00.779)       0:00:00.839 **** 
ok: [192.168.101.69] => {
    "changed": false, 
    "msg": "All assertions passed"
}

TASK [use quiet to avoid verbose output] ***************************************************************************************************************
Thursday 23 September 2021  09:32:02 -0400 (0:00:00.072)       0:00:00.911 **** 
ok: [192.168.101.69] => {
    "changed": false, 
    "msg": "All assertions passed"
}

TASK [print origin fail msg] ***************************************************************************************************************************
Thursday 23 September 2021  09:32:02 -0400 (0:00:00.070)       0:00:00.982 **** 
fatal: [192.168.101.69]: FAILED! => {
    "assertion": "number_of_the_count == 4", 
    "changed": false, 
    "evaluated_to": false
}
	to retry, use: --limit @/root/assert.retry

PLAY RECAP *********************************************************************************************************************************************
192.168.101.69             : ok=3    changed=0    unreachable=0    failed=1   

Thursday 23 September 2021  09:32:02 -0400 (0:00:00.047)       0:00:01.029 **** 
=============================================================================== 
Gathering Facts --------------------------------------------------------------------------------------------------------------------------------- 0.78s
assert param scope ------------------------------------------------------------------------------------------------------------------------------ 0.07s
use quiet to avoid verbose output --------------------------------------------------------------------------------------------------------------- 0.07s
print origin fail msg --------------------------------------------------------------------------------------------------------------------------- 0.05s
```


# 三、fail模块

- fail模块是让当前所执行的任务失败，并输出信息。等与when一起使用时，可以在特定条件下让任务失败，以调试程序。比如：当status与期望值不符时，任务失败并输出变量的值。


## 1、fail参数说明
| 参数 | 参数说明 |
|-----|------|
| msg | 当任务失败时，输出特定的消息。如果没有指定，输出默认消息“Failed as requested from task”。 |

## 2、fail调试示例
```
---
- hosts: devops
  vars:
  number_of_the_count: 5
  tasks:
  - name: use fail module with when
    fail:
    when: number_of_the_count == 5

  - name: use fail module
    fail:
      msg: 'this is a debug msg'
```

## 3、assert执行过程
```
# ansible-playbook fail.yml

PLAY [node01] ******************************************************************************************************************************************

TASK [Gathering Facts] *********************************************************************************************************************************
Thursday 23 September 2021  09:35:59 -0400 (0:00:00.057)       0:00:00.057 **** 
ok: [192.168.101.69]

TASK [use fail module with when] ***********************************************************************************************************************
Thursday 23 September 2021  09:36:00 -0400 (0:00:00.883)       0:00:00.941 **** 
fatal: [192.168.101.69]: FAILED! => {"changed": false, "msg": "Failed as requested from task"}
	to retry, use: --limit @/root/fail.retry

PLAY RECAP *********************************************************************************************************************************************
192.168.101.69             : ok=1    changed=0    unreachable=0    failed=1   

Thursday 23 September 2021  09:36:00 -0400 (0:00:00.048)       0:00:00.989 **** 
=============================================================================== 
Gathering Facts --------------------------------------------------------------------------------------------------------------------------------- 0.88s
use fail module with when ----------------------------------------------------------------------------------------------------------------------- 0.05s
```

# 四、--start-at-task参数

- 有时候在开发阶段调试新增的palybook或task，其中有个任务经常失败，需要不停的重试。如果在这个任务之前还有很多其他成功的任务，如果每次都从头执行，那么每次都需要执行那些已经成功的任务，效率就很低，这时可以通过`--start-at-task`参数指定这个特定的任务。

## 1、`--start-at-task`参数示例
```
# ansible-playbook assert.yml --start-at-task="print origin fail msg"

PLAY [node01] ******************************************************************************************************************************************

TASK [Gathering Facts] *********************************************************************************************************************************
Thursday 23 September 2021  09:38:42 -0400 (0:00:00.057)       0:00:00.057 **** 
ok: [192.168.101.69]

TASK [print origin fail msg] ***************************************************************************************************************************
Thursday 23 September 2021  09:38:43 -0400 (0:00:00.767)       0:00:00.824 **** 
fatal: [192.168.101.69]: FAILED! => {
    "assertion": "number_of_the_count == 4", 
    "changed": false, 
    "evaluated_to": false
}
	to retry, use: --limit @/root/assert.retry

PLAY RECAP *********************************************************************************************************************************************
192.168.101.69             : ok=1    changed=0    unreachable=0    failed=1   

Thursday 23 September 2021  09:38:43 -0400 (0:00:00.050)       0:00:00.875 **** 
=============================================================================== 
Gathering Facts --------------------------------------------------------------------------------------------------------------------------------- 0.77s
print origin fail msg --------------------------------------------------------------------------------------------------------------------------- 0.05s
```

# 五、--step参数

- --step参数与--start-at-task参数不同，--start-at-task参数是从某个特定的任务开始，而--step是以交互的模式一步一步的执行。

每步任务的执行都需要输入三个选项中的一个
- N（跳过）
- Y（执行）
- C（继续执行后面所有步骤）

## 1、`--start-at-task`参数示例
```
# ansible-playbook debug.yml --step

PLAY [node01] ******************************************************************************************************************************************
Perform task: TASK: Gathering Facts (N)o/(y)es/(c)ontinue: y

Perform task: TASK: Gathering Facts (N)o/(y)es/(c)ontinue: *********************************************************************************************

TASK [Gathering Facts] *********************************************************************************************************************************
Thursday 23 September 2021  09:42:45 -0400 (0:00:01.246)       0:00:01.246 **** 
ok: [192.168.101.69]
Perform task: TASK: show debug msg (N)o/(y)es/(c)ontinue: n

Perform task: TASK: show debug msg (N)o/(y)es/(c)ontinue: **********************************************************************************************
Perform task: TASK: print gateway when it is defined (N)o/(y)es/(c)ontinue: n

Perform task: TASK: print gateway when it is defined (N)o/(y)es/(c)ontinue: ****************************************************************************
Perform task: TASK: show uptime (N)o/(y)es/(c)ontinue: c

Perform task: TASK: show uptime (N)o/(y)es/(c)ontinue: *************************************************************************************************

TASK [show uptime] *************************************************************************************************************************************
Thursday 23 September 2021  09:42:50 -0400 (0:00:04.391)       0:00:05.637 **** 
changed: [192.168.101.69]

TASK [show uptime result] ******************************************************************************************************************************
Thursday 23 September 2021  09:42:50 -0400 (0:00:00.380)       0:00:06.018 **** 
skipping: [192.168.101.69]

TASK [display all vars of a host] **********************************************************************************************************************
Thursday 23 September 2021  09:42:50 -0400 (0:00:00.060)       0:00:06.078 **** 
skipping: [192.168.101.69]

TASK [print two lines of messages] *********************************************************************************************************************
Thursday 23 September 2021  09:42:50 -0400 (0:00:00.066)       0:00:06.144 **** 
ok: [192.168.101.69] => {
    "msg": [
        "first line msg", 
        "second line msg"
    ]
}

PLAY RECAP *********************************************************************************************************************************************
192.168.101.69             : ok=3    changed=1    unreachable=0    failed=0   

Thursday 23 September 2021  09:42:50 -0400 (0:00:00.047)       0:00:06.192 **** 
=============================================================================== 
Gathering Facts --------------------------------------------------------------------------------------------------------------------------------- 4.39s
show uptime ------------------------------------------------------------------------------------------------------------------------------------- 0.38s
display all vars of a host ---------------------------------------------------------------------------------------------------------------------- 0.07s
show uptime result ------------------------------------------------------------------------------------------------------------------------------ 0.06s
print two lines of messages --------------------------------------------------------------------------------------------------------------------- 0.05s
```

