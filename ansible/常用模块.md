# wait_for

| 参数 | 描述 |
|------|-----|
| host | 要等待的可解析的主机名或IP地址 |
| port | 要轮训的端口 |
| search_regex | 用于匹配文件或socket链接中的一个字符串 |
| timeout | 等待的超时时间。默认是300秒  |
| delay | 开始轮询之前等待的秒数，默认是0 |
| path | 在继续之前，文件系统上必须存在的文件的路径 |
| exclude_hosts | 与state=drained一起使用。用于指定，在寻找活跃的TCP链接的时候，要忽略的主机或IP列表 |
| state | 可以是present、started、stopped、absent、drained，默认是started。当检查端口的时候，started会确保端口打开；stopped会确保端口关闭；drained会检查活跃的链接。当检查文件或搜索字符串的时候，present和started会确保文件或字符串存在。absent会确保文件不存在或被移除 |



假设需要配置的远程主机刚刚启动，如果直接运行playbook，可能会因为sshd服务尚未开始监听而导致失败，可以在控制主机上使用`wait_for`模块等待被控端sshd端口监听：
```
- hosts: all
  remote_user: root
  gather_facts: no
  tasks:
  - name: "kernel | wait 300 seconds for all nodes's port 22 to become open"
    wait_for:
      host: 192.168.101.69
      port: 22
      delay: 10
      timeout: 300
    connection: local
    become: false
```



```
# ansible-playbook -i host test.yml 

PLAY [all] *********************************************************************************************************************************************

TASK [kernel | wait 300 seconds for all nodes's port 22 to become open] ********************************************************************************
ok: [192.168.101.69]

PLAY RECAP *********************************************************************************************************************************************
192.168.101.69             : ok=1    changed=0    unreachable=0    failed=0 
```


```
- name: wait for ssh server to be running
  wait_for
      port: 22 
      host: "{{ inventory_hostname }}" 
      search_regex: OpenSSH
  connection: local
```

## 案例

1、等待8000端口打开，每10秒检查一次。超时时间是300秒。
```
wait_for: port:8000 delay=10
```

2、等待所有本地IP上的8000端口，关闭活跃连接。每10秒检查一次，超时时间是300秒。
```
wait_for: host=0.0.0.0 port=8000 delay=10 state=drained
```

3、等待所有本地IP上的8000端口，关闭活跃的连接。忽略来自10.2.1.2和10.2.1.3上的连接。超时时间是300秒。
```
wait_for: host=0.0.0.0 port=8000 state=drained exclude_hosts=10.2.1.2,10.2.1.3
```

4、一直等到/tmp/foo这个文件存在。
```
wait_for: path=/tmp/foo
```

5、一直等到字符串completed出现在文件/tmp/foo中。
```
wait_for: path=/tmp/foo search_regex=completed
```

6、一直等到lock文件被删除。
```
wait_for: path=/var/lock/file.lock state=absent
```

7、一直等到进程结束，并且pid被销毁。
```
wait_for: path=/proc/3466/status state=absent
```

8、等待22端口被打开，并且包含字符串OpenSSH。并且不确保inventory_hostname是可解析的。每10秒检查一次，超时时间是300秒。
```
local_action: wait_for port=22 host="{{ ansible_ssh_host | default(inventory_hostname) }}" search_regex=OpenSSH delay=10
```

















