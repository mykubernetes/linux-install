# 魔法变量

- Ansible默认会提供一些内置的变量以实现一些特定的功能，我们称之为魔法变量。下面列举一些常用的魔法变量。

## 1、hostvars

获取某台指定的主机的相关变量。如果有一台web服务器的配置文件中需要指定db服务器的ip地址，我们假定这台db服务器的hostname为db.exmaple.com,ip地址绑定在eth0网卡上，我们可以通过如下方法在web服务器上调用db服务器的ip地址：
```
# vim var_test.yml

- hosts: demo2.example.com
  tasks:
    - debug:
        msg: "{{ ansible_ens33.ipv4.address }}"
```

```
[root@node1 ansible]# ansible-playbook var_test.yml


TASK [debug] **********************************************************************************************************************************
ok: [demo2.example.com] => {
    "msg": "192.168.132.132"                   #这里获取的demo2.example.com
}
```

获取demo3.example.com的地址
```
- hosts: demo2.example.com
  tasks:
    - debug:
        msg: "{{ hostvars['demo3.example.com'].ansible_ens33.ipv4.address }}"
```

```
[root@node1 ansible]# ansible-playbook var_test.yml

TASK [debug] **********************************************************************************************************************************
ok: [demo2.example.com] => {
    "msg": "192.168.132.133"
}
```

# 2、inventory_hostname

inventory_hostname是Ansible所识别的当前正在运行task的主机的主机名。如果在inventory里定义过别名，那么这里就是那个别名，如果inventory包含如下一行：
```
demo6.example.com  ansible_ssh_host=192.168.132.132
```
- 则inventory_hostname即为demo6.example.com

利用hostvars和inventory_hostname变量，可以输出与当前主机相关联的所有变量：
```
# vim var_test.yml

- hosts: demo6.example.com
  tasks:
    - debug:
        msg: "{{ inventory_hostname }}"
    - debug:
        msg: "{{ ansible_fqdn }}"
```

```
# ansible-playbook var_test.yml

TASK [debug] **********************************************************************************************************************************
ok: [demo6.example.com] => {
    "msg": "demo6.example.com"         #别名
 }
TASK [debug] **********************************************************************************************************************************
ok: [demo6.example.com] => {
    "msg": "node2"                     #获取了本身的hostname
}
```

## 3、group_names

用于标识当前正在执行task的目标主机位于的主机组。假如我们有三台主机，用来配置成一主二从的mysql服务器。inventory配置如下：
复制代码
```
demo6.example.com ansible_ssh_host=192.168.132.132
demo5.example.com
demo3.example.com
[datacenter1]
demo1.example.com
demo2.example.com

[datacenter2]
demo3.example.com
demo4.example.com

[webserver]
demo1.example.com
demo2.example.com
demo3.example.com

[mysqlserver]
demo4.example.com
demo5.example.com

[datacenters:children]
datacenter1
datacenter2
```

```
# vim group_name.yml

- hosts: all
  tasks:
    - debug:
        msg: "{{ group_names }}"
```

```
# ansible-playbook group_name.yml

ok: [demo6.example.com] => {
    "msg": [
        "ungrouped"
    ]
}
ok: [demo4.example.com] => {
    "msg": [
        "datacenter2", 
        "datacenters", 
        "mysqlserver"
    ]
}
ok: [demo5.example.com] => {
    "msg": [
        "mysqlserver"
    ]
}
ok: [demo1.example.com] => {
    "msg": [
        "datacenter1", 
        "datacenters", 
        "webserver"
    ]
}
ok: [demo2.example.com] => {
    "msg": [
        "datacenter1", 
        "datacenters", 
        "webserver"
    ]
}
ok: [demo3.example.com] => {
    "msg": [
        "datacenter2", 
        "datacenters", 
        "webserver"
    ]
}
```

## 4、groups

groups是inventory中所有主机组的列表，可用于枚举主机组中的所有主机。
```
# vim group_name.yml

- hosts: demo2.example.com
  tasks:
    - debug:
        msg: "{{ groups.webserver }}"
```                       

```
# ansible-playbook group_name.yml

TASK [debug] **********************************************************************************************************************************
ok: [demo2.example.com] => {
    "msg": [
        "demo1.example.com", 
        "demo2.example.com", 
        "demo3.example.com"
    ]
}
```

应用场景，需要把一组下面的被控端都安装配置文件
```
# cat files/haproxy.cfg

{% for i in groups.webserver%}
    server {{ i }};
{% endfor %}
```

```
# vim group_name.yml

- hosts: demo2.example.com
  tasks:
    - package:
        name: haproxy
        state: installed
    - template:
        src: ./files/haproxy.cfg
        dest: /etc/haproxy.cgf
```

执行
```
# ansible-playbook group_name.yml 

# ansible demo2.example.com -m shell -a 'cat /tmp/haproxy.cgf'

demo2.example.com | CHANGED | rc=0 >>
    server demo1.example.com;
    server demo2.example.com;
    server demo3.example.com;
```
