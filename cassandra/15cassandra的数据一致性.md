一致性指的是怎样更新到最新并且在所有副本节点上同步Cassandra的一行数据。Cassandra通过提供可以调节的数据一致性扩充了最终一致性的观点，对于任何读取或写入操作，客户端决定请求数据的一致性。

除了可配置的一致性以外，Cassandra通过很多的built-in repair mechanisms去保证数据在各个副本之间的一致性。

提示：你可能觉得这个工具非常有用当决定一致性的级别时。


# 一、关于客户端请求的可调节的一致性

Cassandra中的一致性可以被配置去管理响应的时间和数据的准确性。你可以配置集群、数据中心或者个人I/O操作的一致性。

通过使用Cassandra驱动或者客户端库，在参与的节点中达到非常强的或最终的一致性是可以被全局设置和控制的。

# 二、写一致性

- 一致性级别指定多少副本节点的数目应当在成功后返回一个响应给客户端。

写一致性级别

| 级别 | 描述 | 使用 |
|-----|------|-----|
| ANY | 一个写入必须被写入到至少一个节点中。如果给定行所有的副本都宕机了，写入仍然会返回成功当hint被写入了。如果在写入的时候所有的副本都宕机了，一个ANY写入不可读直到副本节点被发现。 | 提供了低的延迟和写入永远不会失败的保证。相比于其他级别，提供了最低的一致性和最高的可用性。 |
| ONE | 一个写入必须被写到至少一个副本节点的commit log文件和内存表中。 | 满足了大部分用户的需求因为一致性级别要求不严格。和协调者节点最近的副本节点接收到请求。 |
| TWO | 一个写入必须被写到至少两个副本节点的commit log文件和内存表中。 | 和ONE相似 |
| THREE | 一个写入必须被写到至少三个副本节点的commit log文件和内存表中。 | 和TWO相似 |
| QUORUM | 一个写入必须被写到规定数目副本节点的commit log文件和内存表中。 | 提供了强一致性如果你能忍受一定基本的错误 |
| LOCAL_ONE | 在Cassandra1.2.11及之后可用。一个写入会被发送、成功接收到一个本地数据中心的副本节点。 | 在一个多数据中心的集群，一致性级别ONE经常能令人满意，但是不能跨越数据中心。LOCAL_ONE能够实现这个。为了安全和质量原因，当在线的节点宕机后，你可以使用这个一致性级别在一个脱机的数据中心以避免自动连接到其他的在线节点。 |
| LOCAL_QUORUM | 一个写入必须被写到和协调者同一个数据中心中规定数目副本节点的commit log文件和内存表中。避免了节点内通信的延迟。 | 使用在多数据中心集群配置策略为NetworkTopologyStrategy并且一个适当配置的snitch。当使用SimpleStrategy会失败。在维护本地的一致性（在一个数据中心）中使用。 |
| EACH_QUORUM | 一个写入必须被写到所有节点中规定数目副本节点的commit log文件和内存表中。 | 在多数据中心集群中使用，严格维护多个数据中心的具有相同的一致性。例如，在你需要读写失败当数据集群宕机并且数据中心不能达到QUORUM时可以使用这一级别。 |
| ALL | 一个写入必须被写到集群中所有的应当存储row的副本节点的commit log文件和内存表中。 | 相对于其他级别，提供了最高的一致性和最低的可用性。 |

- 即使一致性级别为ONE或者LOCAL_QUORUM，写入仍然会发送到所有的副本节点，即使副本节点在其他的数据中心。一致性级别决定了多少副本节点应当对接收到的写入做出反应。

# 三、读一致性

- 一致性级别决定了多少副本节点应当在返回数据给客户端之前响应一个读请求。为了满足读请求，Cassandra根据时间戳检查指定的数目的副本节点的数据去找到最新的数据。 

写一致性级别

| 级别 | 描述 | 使用 |
|-----|------|-----|
| ONE | 根据snitch，从最近的一个节点返回数据。默认地，一个读修复会在后台运行去保证其他副本的一致性。 | 提供了最高级别的可用性，如果你能忍受很高概率的情况下你获得的数据不是最新的。 |
| TWO | 从最近的两个节点中返回最新的数据 | 和ONE相似 |
| THREE | 从最近的三个节点中返回最新的数据 | 和TWO相似 |
| QUORUM | 从响应的规定数目的副本节点中返回最新时间戳的数据 | 提供了强一致性如果你能忍受一定基本的错误 |
| LOCAL_ONE | 在Cassandra1.2.11及之后可用。根据snitch，从一个最近的副本节点获得相应，这个副本节点是在本地数据中心的。 | 和写一致性LOCAL_ONE级别的相同 |
| LOCAL_QUORUM | 从协调者所在的数据中心中从规定数目的节点响应中返回最新的数据。避免了节点内通信的延迟。 | 使用在多数据中心集群配置策略为NetworkTopologyStrategy并且一个适当配置的snitch。当使用SimpleStrategy会失败。 |
| EACH_QUORUM | 从集群的每一个数据中心中的规定数目的节点响应中返回最新的数据。 | 和LOCAL_QUORUM 相同 |
| ALL | 从所有的副本节点中返回最新的时间戳。如果一个副本节点没有响应，读取操作会失败。 | 相对于其他级别，提供了最高的一致性和最低的可用性。 |

  
# 四、QUORUM级别

QUORUM级别写入节点的数目成为了一个对顶。这个可以计算的，然后向下舍入到一个整数，如下：
```
( 复制因子 / 2 ) + 1
```
例如：使用复制因子为3，计算结果是2——集群可以忍受1个节点的宕机。使用复制因子为6，计算结果是4——集群可以忍受2个节点的宕机。

如果一致性是最重要的，你可以确保读总是会影响最新的写通过使用以下公式：
```
( 正在写入的节点 + 正在读取的节点 ) > 复制因子
```

例如，如果你的应用程序使用一致性级别为QUORUM的写和读，如果你的复制因子是3，这样确保了2个节点总是被写入并且2个节点总是在读取。
```
读写节点组合（4）大于复制因子（3）保证读的强一致性。
```
 

# 五、配置客户端一致性级别

你可以使用一个新的cqlsh命令——keyspace，设置keyspace的一致性级别。

在CQL 3版本中，WITH CONSISTENCY语句已经从CQL 3命令中移除。从编程上来说，可以在驱动级别上设置一致性级别。例如，通过二进制查询、压缩设置、一致性级别调用execute_cql3_query。默认的读和写一致性级别为ONE。

 

# 六、内置的一致性修复特性

你可以使用这些内置的修复特性去保证数据在副本中的一致性。
